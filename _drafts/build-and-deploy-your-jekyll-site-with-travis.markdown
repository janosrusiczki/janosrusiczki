The goal of this endeavour was to build and deploy the blog via an external service which is triggered by pushing to a certain GitHub branch (in my case `master`). I wanted local configuration to be minimal so in case of a server switch I don't have much to do except configuring nginx and a virtual host for it. The CI service of choice was [Travis](https://travis-ci.org/) because I used it for [jekyll_asset_pipeline](https://github.com/matthodan/jekyll-asset-pipeline) and some other open source side projects I'm working on.

## Build

Building a piece of software usually consists of the build part itself followed by testing. The actual build part in Jekyll's case is straight forward, even the command is called `jekyll build`, but I was wondering about the second part: as opposed to a piece of software what can you test on a static site? The answer came as [html-proofer](https://github.com/gjtorikian/html-proofer) which checks your site's HTML files for the correctness of inbound and outbound links, image references, the presence of alt tags on the images, etc.

Continuous integration of a Jekyll site with Travis is [very well documented](https://jekyllrb.com/docs/continuous-integration/travis-ci/) so I will stick to describing what I needed to change.

I decided to run html-proofer via rake instead of a stand alone command as described in the article above so I could add some configuration. My `Rakefile` looks like this:

    require 'html-proofer'

    task :test do
      options = {
        url_ignore: [
          '/feed/',
          /^\/assets/
        ],
        internal_domains: [
          'https://content.rusiczki.net'
        ]
      }
      HTMLProofer.check_directories(["./_site/#{Date.current.year}/", "./_site/#{Date.current.year - 1}/"], options).run
    end

You might notice that the HTMLProofer invocation is only run on two directories (containing posts from the current year and the one before) and this is because I have a blog with ancient content which is mostly irrelevant. Also, I decided to have my assets on a separate subdomain which I had to add so that html-proofer considers it local. /feed/ is redirected from the vhost config so I set that to be ignored. The /assets/* links are also ignored because they are generated by the gem I'm maintaining but with relative URLs for the moment.

https://github.com/janosrusiczki/janosrusiczki/commit/24acd18d0f5fc2f840d9982021e0d8dcbfc55d31
https://github.com/janosrusiczki/janosrusiczki/commit/768bbad083fe76d5878dce91dff0514a3b385f9b

## Deploy

Based on this article https://oncletom.io/2016/travis-ssh-deploy/

    travis encrypt-file deploy_rsa --add
    encrypting deploy_rsa for janosrusiczki/janosrusiczki
    storing result as deploy_rsa.enc
    storing secure env variables for decryption
    not logged in - try running travis login --org

If on the same server / user use the following to add the authorized key
13:31 $ cat deploy_rsa.pub >> ~/.ssh/authorized_keys

    travis encrypt DEPLOY_DIRECTORY=<deploy directory> --add
    travis encrypt DEPLOY_HOST=<deploy host> --add
    travis encrypt DEPLOY_USER=<deploy user> --add

before_deploy:
  - echo -e "Host heroku.com\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config
  - echo -e "Host github.com\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config
